<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneDrive Qualitative Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- MSAL.js for authentication -->
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
    <!-- Docx.js for report generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #2563eb);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: s3 1s infinite linear;
        }
        @keyframes s3 {
            to {
                transform: rotate(1turn)
            }
        }
        /* Style for the file picker modal */
        #file-picker-modal ul { max-height: 400px; overflow-y: auto; }
        #file-picker-modal li { cursor: pointer; }
        #file-picker-modal li:hover { background-color: #f0f4ff; }
        #file-picker-modal li.selected { background-color: #dbeafe; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">OneDrive Qualitative Analysis Tool</h1>
            <p class="mt-2 text-md text-gray-600">Analyze files from OneDrive and generate Word reports with Gemini AI.</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-gray-200">

            <!-- Step 1: OneDrive Integration -->
            <div id="step1-onedrive" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Step 1: Connect & Select Files</h2>
                <div id="auth-container" class="flex flex-col sm:flex-row items-center gap-4">
                    <button id="signInButton" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md w-full sm:w-auto flex items-center justify-center">Connect to OneDrive</button>
                    <button id="signOutButton" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 w-full sm:w-auto" style="display: none;">Sign Out</button>
                    <p id="auth-status" class="text-sm text-gray-500 mt-2 sm:mt-0"></p>
                </div>
                 <div id="file-selector-container" class="mt-6" style="display: none;">
                    <button id="selectFilesButton" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md w-full">Select Files from OneDrive</button>
                    <div id="file-list" class="mt-4 space-y-2"></div>
                </div>
            </div>

            <!-- Step 2: Analysis Options -->
            <div id="step2-analysis" class="mb-8" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Step 2: Choose Analysis Types</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4 p-4 rounded-lg bg-gray-50 border">
                        <label class="flex items-center space-x-3 text-lg font-medium">
                            <input type="checkbox" name="analysis_type" value="thematic" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span>Thematic Analysis</span>
                        </label>
                        <label class="flex items-center space-x-3 text-lg font-medium">
                            <input type="checkbox" name="analysis_type" value="narrative" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span>Narrative Analysis</span>
                        </label>
                        <label class="flex items-center space-x-3 text-lg font-medium">
                            <input type="checkbox" name="analysis_type" value="discourse" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span>Discourse Analysis</span>
                        </label>
                    </div>
                    <div class="space-y-4 p-4 rounded-lg bg-gray-50 border">
                        <div class="space-y-2">
                             <label class="flex items-center space-x-3 text-lg font-medium">
                                <input type="checkbox" id="framework_checkbox" name="analysis_type" value="framework" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span>Framework-based Analysis</span>
                            </label>
                            <div id="framework_input_container" class="pl-8" style="display: none;">
                                <label for="framework_file" class="text-sm font-medium text-gray-700">Upload Framework/Rubric (txt):</label>
                                <input type="file" id="framework_file" accept=".txt" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 text-lg font-medium">
                                <input type="checkbox" id="reflection_checkbox" name="analysis_type" value="reflection" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span>Models of Reflection</span>
                            </label>
                             <div id="reflection_model_container" class="pl-8" style="display: none;">
                                <select id="reflection_model" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="schon">Schön's Reflection in Action</option>
                                    <option value="gibbs">Gibbs' Reflective Cycle</option>
                                    <option value="moon">Moon's Levels of Reflection</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Run Analysis -->
            <div id="step3-run" class="mt-10 text-center" style="display: none;">
                 <button id="run_analysis_button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-xl text-lg w-full sm:w-auto">Analyze & Generate Reports</button>
            </div>

            <!-- Results and Loading -->
            <div id="results-container" class="mt-10" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Analysis Progress</h2>
                <div id="loader" class="flex items-center justify-center py-8" style="display: none;">
                    <div class="custom-loader"></div>
                    <p class="ml-4 text-lg text-gray-600">Analyzing files... Please wait.</p>
                </div>
                <div id="report-links" class="space-y-3"></div>
            </div>
        </div>
    </div>
    
    <!-- OneDrive File Picker Modal -->
    <div id="file-picker-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-auto">
            <h3 class="text-xl font-bold mb-4">Select Files from OneDrive</h3>
            <div id="file-picker-loader" class="text-center py-4" style="display: none;">Loading files...</div>
            <ul id="onedrive-file-list" class="border rounded-md divide-y">
                <!-- File list will be injected here -->
            </ul>
            <div class="mt-6 flex justify-end gap-4">
                <button id="file-picker-cancel" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="file-picker-confirm" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Confirm Selection</button>
            </div>
        </div>
    </div>

    <!-- General Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[60]" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">Notification</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="mt-6 text-right">
                <button id="modal-close-button" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Close</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- Configuration ---
        const MSAL_CLIENT_ID = "6d164013-c808-4f9e-8c83-c7c1670c976e"; // IMPORTANT: Replace with your Azure App Client ID
        const GEMINI_API_KEY = "AIzaSyCWtwOFW981thNiwcx0AsITMNqt8fLU8ZQ"; // IMPORTANT: Replace with your Gemini API Key

        const msalConfig = {
            auth: {
                clientId: MSAL_CLIENT_ID,
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: "sessionStorage", 
                storeAuthStateInCookie: false,
            }
        };

        const loginRequest = {
            scopes: ["User.Read", "Files.Read.All"],
            prompt: 'select_account' 
        };

        const graphConfig = {
            graphMeEndpoint: "https://graph.microsoft.com/v1.0/me",
            graphFilesEndpoint: "https://graph.microsoft.com/v1.0/me/drive/root/children"
        };
        
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // --- State ---
        let selectedFiles = [];
        let frameworkContent = '';

        // --- DOM Elements ---
        const signInButton = document.getElementById('signInButton');
        const signOutButton = document.getElementById('signOutButton');
        const selectFilesButton = document.getElementById('selectFilesButton');
        const authStatus = document.getElementById('auth-status');
        const fileSelectorContainer = document.getElementById('file-selector-container');
        const fileListDiv = document.getElementById('file-list');
        const step2Analysis = document.getElementById('step2-analysis');
        const step3Run = document.getElementById('step3-run');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const reportLinks = document.getElementById('report-links');
        const runAnalysisButton = document.getElementById('run_analysis_button');
        const frameworkCheckbox = document.getElementById('framework_checkbox');
        const frameworkInputContainer = document.getElementById('framework_input_container');
        const frameworkFile = document.getElementById('framework_file');
        const reflectionCheckbox = document.getElementById('reflection_checkbox');
        const reflectionModelContainer = document.getElementById('reflection_model_container');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');
        const filePickerModal = document.getElementById('file-picker-modal');
        const filePickerLoader = document.getElementById('file-picker-loader');
        const onedriveFileList = document.getElementById('onedrive-file-list');
        const filePickerCancel = document.getElementById('file-picker-cancel');
        const filePickerConfirm = document.getElementById('file-picker-confirm');

        // --- Initialization ---
        window.onload = () => {
            if (MSAL_CLIENT_ID === 'YOUR_MSAL_CLIENT_ID' || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                showMessageModal('Configuration Needed', 'Please provide your Azure App Client ID and Gemini API Key in the script.');
            }
            // Handle the redirect promise, which is a best practice for all MSAL applications
            msalInstance.handleRedirectPromise()
                .then(handleResponse)
                .catch((error) => {
                    console.error(error);
                });
        };

        // --- Authentication ---
        signInButton.addEventListener("click", () => {
            signInButton.disabled = true; // Disable button to prevent double clicks
            signInButton.innerHTML = `<span class="custom-loader" style="width:20px; height:20px; border-width: 2px; display:inline-block; margin-right: 8px;"></span>Connecting...`;

            msalInstance.loginPopup(loginRequest)
                .then(handleResponse)
                .catch(error => {
                    console.error(error);
                    // If user cancelled, provide gentle UI feedback instead of an error modal
                    if (error.errorCode === "user_cancelled") {
                        authStatus.textContent = "Login was cancelled.";
                        console.log("User cancelled the login flow. This is expected and not an application error.");
                        // Clear the message after a few seconds
                        setTimeout(() => {
                            if (authStatus.textContent === "Login was cancelled.") {
                                 authStatus.textContent = "";
                            }
                        }, 3000);
                    } 
                    // For other errors, show a detailed modal
                    else if (error.errorCode !== "interaction_in_progress") {
                       let errorMessage = error.errorMessage;
                       if (errorMessage && errorMessage.includes("AADSTS50011")) {
                           errorMessage += "\n\nThis error means the Redirect URI is incorrect. Please go to your Azure App Registration, click 'Authentication', and ensure you have a 'Single-page application (SPA)' platform with a Redirect URI that exactly matches this page's origin URL.";
                       }
                       showMessageModal("Login Failed", `An error occurred during login: ${errorMessage || "Please check the console for details."}`);
                    }
                    // For 'interaction_in_progress', we do nothing, letting the first interaction complete.
                })
                .finally(() => {
                    // Always reset the button state if no user is signed in.
                    if (!msalInstance.getActiveAccount()) {
                        signInButton.disabled = false; 
                        signInButton.innerHTML = "Connect to OneDrive";
                    }
                });
        });

        signOutButton.addEventListener("click", () => {
            const logoutRequest = {
                account: msalInstance.getActiveAccount(),
                postLogoutRedirectUri: window.location.origin
            };
            msalInstance.logoutPopup(logoutRequest);
            updateUIForSignedOut();
        });

        function handleResponse(response) {
            if (response !== null) {
                updateUIForSignedIn(response.account);
            } else {
                const currentAccounts = msalInstance.getAllAccounts();
                if (currentAccounts.length === 0) {
                    return;
                } else if (currentAccounts.length > 1) {
                    updateUIForSignedIn(currentAccounts[0]);
                } else if (currentAccounts.length === 1) {
                    updateUIForSignedIn(currentAccounts[0]);
                }
            }
             // Ensure button is enabled after any interaction attempt
            if (!msalInstance.getActiveAccount()) {
                signInButton.disabled = false;
                signInButton.innerHTML = "Connect to OneDrive";
            }
        }
        
        function updateUIForSignedIn(account) {
            signInButton.style.display = 'none';
            signOutButton.style.display = 'block';
            authStatus.textContent = `Connected as ${account.username}`;
            fileSelectorContainer.style.display = 'block';
        }

        function updateUIForSignedOut() {
            signInButton.style.display = 'block';
            signOutButton.style.display = 'none';
            authStatus.textContent = '';
            fileSelectorContainer.style.display = 'none';
            step2Analysis.style.display = 'none';
            step3Run.style.display = 'none';
            fileListDiv.innerHTML = '';
            selectedFiles = [];
        }

        // --- Microsoft Graph API Calls ---
        async function getGraphToken() {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                throw new Error("No active account! Please sign in again.");
            }
            const response = await msalInstance.acquireTokenSilent({
                ...loginRequest,
                account: account
            });
            return response.accessToken;
        }

        async function getOneDriveFiles() {
            try {
                const accessToken = await getGraphToken();
                const response = await fetch(graphConfig.graphFilesEndpoint, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Graph API Error:", errorData);
                    let userMessage = `Failed to retrieve files. Status: ${response.status}.`;
                    if (response.status === 403) {
                        userMessage += "\n\nThis 'Forbidden' error means the app does not have the required API permissions. Please go to your Azure App Registration, click 'API permissions', and ensure 'Files.Read.All' is added and granted admin consent.";
                    }
                    throw new Error(userMessage);
                }

                const data = await response.json();
                return data.value;
            } catch (error) {
                console.error("Could not get files from OneDrive", error);
                // If the error is already a user-friendly message, show it directly.
                // Otherwise, show a generic message.
                const message = error.message.includes("Failed to retrieve files") ? error.message : "An unexpected error occurred while fetching files. Your session might have expired. Please try signing out and in again.";
                showMessageModal("OneDrive Error", message);
                return [];
            }
        }

        async function getFileContent(fileId) {
             try {
                const accessToken = await getGraphToken();
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Graph API returned ${response.status}`);
                }
                return await response.text();
            } catch (error) {
                console.error("Could not get file content", error);
                showMessageModal("OneDrive Error", `Failed to read file content. Error: ${error.message}`);
                throw error;
            }
        }


        // --- File Picker Logic ---
        selectFilesButton.addEventListener('click', async () => {
            filePickerModal.style.display = 'flex';
            filePickerLoader.style.display = 'block';
            onedriveFileList.innerHTML = '';

            const files = await getOneDriveFiles();
            filePickerLoader.style.display = 'none';

            if (files && files.length > 0) {
                files.forEach(file => {
                    // We only care about files, not folders, and text-based files
                    if (file.file && (file.name.endsWith('.txt') || file.name.endsWith('.docx'))) {
                        const li = document.createElement('li');
                        li.textContent = file.name;
                        li.dataset.id = file.id;
                        li.dataset.name = file.name;
                        li.className = 'p-3 border-b last:border-b-0';
                        li.onclick = () => li.classList.toggle('selected');
                        onedriveFileList.appendChild(li);
                    }
                });
            } else {
                onedriveFileList.innerHTML = '<li class="p-3 text-gray-500">No text or docx files found in your OneDrive root folder.</li>';
            }
        });
        
        filePickerCancel.addEventListener('click', () => filePickerModal.style.display = 'none');
        
        filePickerConfirm.addEventListener('click', () => {
            selectedFiles = Array.from(onedriveFileList.querySelectorAll('li.selected')).map(li => ({
                id: li.dataset.id,
                name: li.dataset.name
            }));
            
            fileListDiv.innerHTML = '<h3 class="font-semibold text-gray-700">Selected Files:</h3>';
            const list = document.createElement('ul');
            list.className = 'list-disc list-inside bg-gray-100 p-3 rounded-md';
            selectedFiles.forEach(file => {
                const listItem = document.createElement('li');
                listItem.textContent = file.name;
                list.appendChild(listItem);
            });
            fileListDiv.appendChild(list);

            if (selectedFiles.length > 0) {
                step2Analysis.style.display = 'block';
                step3Run.style.display = 'block';
            }
            filePickerModal.style.display = 'none';
        });

        // --- Analysis Logic ---
        frameworkCheckbox.addEventListener('change', (e) => frameworkInputContainer.style.display = e.target.checked ? 'block' : 'none');
        reflectionCheckbox.addEventListener('change', (e) => reflectionModelContainer.style.display = e.target.checked ? 'block' : 'none');
        frameworkFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => frameworkContent = event.target.result;
                reader.readAsText(file);
            }
        });

        async function performGeminiAnalysis(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API request failed: ${errorBody.error.message}`);
                }
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showMessageModal("AI Analysis Failed", `An error occurred: ${error.message}`);
                throw error;
            }
        }

        runAnalysisButton.addEventListener('click', async () => {
            const selectedAnalyses = Array.from(document.querySelectorAll('input[name="analysis_type"]:checked')).map(cb => cb.value);
            if (selectedFiles.length === 0) {
                showMessageModal('Error', 'Please select at least one file.');
                return;
            }
            if (selectedAnalyses.length === 0) {
                showMessageModal('Error', 'Please choose at least one analysis type.');
                return;
            }

            resultsContainer.style.display = 'block';
            loader.style.display = 'flex';
            reportLinks.innerHTML = '';

            for (const file of selectedFiles) {
                try {
                    // Note: Reading .docx content in the browser is complex. This example treats it as plain text.
                    // For true .docx parsing, a library like mammoth.js would be needed.
                    const fileContent = await getFileContent(file.id);
                    const analysisResults = {};

                    for (const type of selectedAnalyses) {
                        const prompt = generatePrompt(type, fileContent);
                        const result = await performGeminiAnalysis(prompt);
                        analysisResults[type] = result;
                    }
                    
                    generateWordDocument(file.name, fileContent, analysisResults, selectedAnalyses);

                } catch (error) {
                    const errorLink = document.createElement('p');
                    errorLink.className = 'text-red-500';
                    errorLink.textContent = `Failed to process ${file.name}. See console for details.`;
                    reportLinks.appendChild(errorLink);
                }
            }
            loader.style.display = 'none';
        });
        
        function generatePrompt(analysisType, text) {
            let prompt = `You are a qualitative research assistant. Analyze the following text: "${text.substring(0, 8000)}".\n\n`;
            switch (analysisType) {
                case 'thematic':
                    prompt += "Perform a rigorous thematic analysis. Identify 3-5 key themes. For each theme, provide a clear title, a detailed description, and include at least two direct supporting quotes from the text. Format the output clearly with headings for each theme.";
                    break;
                case 'narrative':
                    prompt += "Perform a detailed narrative analysis. Identify the plot, characters, setting, and key narrative arcs. Discuss the overall structure and impact of the narrative. Format the output into clear sections for Plot, Characters, and Setting.";
                    break;
                case 'discourse':
                    prompt += "Perform a critical discourse analysis. Examine the use of language, social context, and how language constructs meaning and power relations. Provide specific examples from the text.";
                    break;
                case 'framework':
                    prompt += `Analyze the text using this framework:\n\n---FRAMEWORK---\n${frameworkContent}\n\n---END FRAMEWORK---\n\nApply the text to each component of the framework, providing a detailed evaluation with specific examples.`;
                    break;
                case 'reflection':
                    const model = document.getElementById('reflection_model').value;
                    let modelDesc = '';
                    if (model === 'schon') modelDesc = "Schön's model of Reflection-in/on-Action. Identify moments of reflection, distinguishing between reflection during an event (in-action) and after an event (on-action), providing textual evidence.";
                    if (model === 'gibbs') modelDesc = "Gibbs' Reflective Cycle (Description, Feelings, Evaluation, Analysis, Conclusion, Action Plan). Structure the analysis according to these six stages, using the text to fill in each section.";
                    if (model === 'moon') modelDesc = "Moon's Levels of Reflection (Noticing, Making Sense, Making Meaning, Working with Meaning, Transformative Learning). Assess the depth of reflection according to these levels, with justification and evidence.";
                    prompt += `Analyze the text using ${modelDesc}`;
                    break;
            }
            return prompt;
        }

        function generateWordDocument(fileName, originalText, results, analysisTypes) {
            const { Document, Packer, Paragraph, HeadingLevel } = docx;
            const sections = [
                { children: [new Paragraph({ text: `Analysis Report for: ${fileName}`, heading: HeadingLevel.TITLE })] },
                { children: [new Paragraph({ text: "Original Text (Excerpt)", heading: HeadingLevel.HEADING_1 }), new Paragraph(originalText.substring(0, 2000) + (originalText.length > 2000 ? "..." : ""))] }
            ];

            analysisTypes.forEach(type => {
                let title = '';
                if (type === 'reflection') {
                    const modelEl = document.getElementById('reflection_model');
                    title = `Reflection Analysis: ${modelEl.options[modelEl.selectedIndex].text}`;
                } else {
                    title = `${type.charAt(0).toUpperCase() + type.slice(1)} Analysis`;
                }
                
                sections.push({
                    children: [
                        new Paragraph({ text: title, heading: HeadingLevel.HEADING_1 }),
                        ...results[type].split('\n').map(line => new Paragraph({ text: line }))
                    ]
                });
            });

            const doc = new Document({ sections });
            Packer.toBlob(doc).then(blob => {
                saveAs(blob, `Report-${fileName}.docx`);
            });
        }
        
        // --- Modal ---
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }
        modalCloseButton.onclick = () => messageModal.style.display = 'none';

    </script>
</body>
</html>
