<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qualitative Analysis & Reporting Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #4f46e5);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: s3 1s infinite linear;
        }
        @keyframes s3 {
            to {
                transform: rotate(1turn)
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Qualitative Analysis & Reporting Tool</h1>
            <p class="mt-2 text-md text-gray-600">Powered by Gemini AI. Deployable on Vercel.</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-gray-200">

            <!-- Step 1: Google Drive Integration -->
            <div id="step1-gdrive" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Step 1: Connect & Select Files</h2>
                <div id="auth-container" class="flex flex-col sm:flex-row items-center gap-4">
                    <button id="authorize_button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md w-full sm:w-auto opacity-50 cursor-not-allowed" disabled>Connect to Google Drive</button>
                    <button id="signout_button" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 w-full sm:w-auto" style="display: none;">Sign Out</button>
                    <p id="auth-status" class="text-sm text-gray-500 mt-2 sm:mt-0"></p>
                </div>
                 <div id="file-picker-container" class="mt-6" style="display: none;">
                    <button id="pick_files_button" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md w-full">Select Files from Drive</button>
                    <div id="file-list" class="mt-4 space-y-2"></div>
                </div>
            </div>

            <!-- Step 2: Analysis Options -->
            <div id="step2-analysis" class="mb-8" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Step 2: Choose Analysis Types</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4 p-4 rounded-lg bg-gray-50 border">
                        <label class="flex items-center space-x-3 text-lg font-medium">
                            <input type="checkbox" name="analysis_type" value="thematic" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span>Thematic Analysis</span>
                        </label>
                        <label class="flex items-center space-x-3 text-lg font-medium">
                            <input type="checkbox" name="analysis_type" value="narrative" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span>Narrative Analysis</span>
                        </label>
                        <label class="flex items-center space-x-3 text-lg font-medium">
                            <input type="checkbox" name="analysis_type" value="discourse" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span>Discourse Analysis</span>
                        </label>
                    </div>
                    <div class="space-y-4 p-4 rounded-lg bg-gray-50 border">
                        <!-- Framework-based Analysis -->
                        <div class="space-y-2">
                             <label class="flex items-center space-x-3 text-lg font-medium">
                                <input type="checkbox" id="framework_checkbox" name="analysis_type" value="framework" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span>Framework-based Analysis</span>
                            </label>
                            <div id="framework_input_container" class="pl-8" style="display: none;">
                                <label for="framework_file" class="text-sm font-medium text-gray-700">Upload Framework/Rubric (txt):</label>
                                <input type="file" id="framework_file" accept=".txt" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            </div>
                        </div>
                        <!-- Models of Reflection -->
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 text-lg font-medium">
                                <input type="checkbox" id="reflection_checkbox" name="analysis_type" value="reflection" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span>Models of Reflection</span>
                            </label>
                             <div id="reflection_model_container" class="pl-8" style="display: none;">
                                <select id="reflection_model" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="schon">Sch√∂n's Reflection in Action</option>
                                    <option value="gibbs">Gibbs' Reflective Cycle</option>
                                    <option value="moon">Moon's Levels of Reflection</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Run Analysis -->
            <div id="step3-run" class="mt-10 text-center" style="display: none;">
                 <button id="run_analysis_button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-xl text-lg w-full sm:w-auto">Analyze & Generate Reports</button>
            </div>

            <!-- Results and Loading -->
            <div id="results-container" class="mt-10" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Analysis Progress</h2>
                <div id="loader" class="flex items-center justify-center py-8" style="display: none;">
                    <div class="custom-loader"></div>
                    <p class="ml-4 text-lg text-gray-600">Analyzing files... Please wait.</p>
                </div>
                <div id="report-links" class="space-y-3"></div>
            </div>

        </div>
    </div>
    
    <!-- Modal for Messages -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">Notification</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="mt-6 text-right">
                <button id="modal-close-button" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Close</button>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        // --- Configuration ---
        // IMPORTANT: Replace with your actual credentials from the Google Cloud Console.
        const CLIENT_ID = '708803702762-ckmt5gi1f51oq7mc5dfa0hlnp8jkjnm6.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyCf8OofANGdmhXoMOM-A7-WmKfzbYg0ZM4'; 
        const GEMINI_API_KEY = 'AIzaSyCVa0PJMnlaqsQ0iQQXcVFQcQbsN--82uA'; // IMPORTANT: Add your Gemini API Key here.

        // The Google Picker API does not have a discovery document. Only include REST APIs here.
        const DISCOVERY_DOCS = [
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let selectedFiles = [];
        let frameworkContent = '';

        // --- DOM Elements ---
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const pickFilesButton = document.getElementById('pick_files_button');
        const runAnalysisButton = document.getElementById('run_analysis_button');
        const authStatus = document.getElementById('auth-status');
        const filePickerContainer = document.getElementById('file-picker-container');
        const fileListDiv = document.getElementById('file-list');
        const step2Analysis = document.getElementById('step2-analysis');
        const step3Run = document.getElementById('step3-run');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const reportLinks = document.getElementById('report-links');
        
        const frameworkCheckbox = document.getElementById('framework_checkbox');
        const frameworkInputContainer = document.getElementById('framework_input_container');
        const frameworkFile = document.getElementById('framework_file');
        
        const reflectionCheckbox = document.getElementById('reflection_checkbox');
        const reflectionModelContainer = document.getElementById('reflection_model_container');
        
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        // --- Initialization ---
        window.onload = () => {
            if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID' || API_KEY === 'YOUR_GOOGLE_API_KEY' || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                showMessageModal('Configuration Needed', 'Please replace the placeholder API keys and Client ID in the script with your actual credentials.');
                return;
            }
            gapiLoaded();
            gisLoaded();
        };
        
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global error caught:", message, error);
            showMessageModal("Critical Script Error", "An unexpected error occurred. This might be due to network issues or an ad blocker interfering with Google's scripts. Please check the console for details.");
            return true;
        };

        function gapiLoaded() {
            gapi.load('client:picker', {
                callback: initializeGapiClient,
                onerror: (error) => {
                     console.error("GAPI load error:", error);
                     showMessageModal('Google Script Load Failed', 'Failed to load a required Google script. Please check your network connection and disable any ad blockers.');
                }
            });
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableAuth();
            } catch (error) {
                console.error("GAPI client initialization error:", error);
                let details = "An unknown error occurred.";
                 if (error.message && error.message.includes('API discovery response missing required fields')) {
                    details = "This specific error often means the API Key is invalid or restricted, or that the 'Google Drive API' is not enabled in your Google Cloud project. Please double-check these settings in the Google Cloud Console.";
                } else if (error.result && error.result.error && error.result.error.code === 404) {
                    details = "This 404 error means a specified API service was not found. Please ensure the 'Google Drive API' is enabled in your Google Cloud project.";
                } else if (error.message && error.message.includes('API key not valid')) {
                    details = "The Google API Key is invalid. Please check it in the Google Cloud Console.";
                } else {
                    details = error.details || "Check API Key and ensure the Google Drive & Picker APIs are enabled in your Google Cloud project.";
                }
                showMessageModal('Google API Init Failed', `Could not initialize Google services. ${details}`);
            }
        }


        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse, 
                });
                gisInited = true;
                maybeEnableAuth();
            } catch (error) {
                console.error("GIS initialization error:", error);
                showMessageModal('Google Auth Init Failed', `Could not initialize Google Authentication. This is often caused by an invalid Client ID format or a problem with the "Authorized JavaScript origins" in your Google Cloud Console.`);
            }
        }
        
        function maybeEnableAuth() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
                authorizeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Authentication ---
        authorizeButton.onclick = () => {
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        };

        async function handleAuthResponse(resp) {
            if (resp.error !== undefined) {
                console.error("Google Auth Error:", resp);
                showMessageModal('Authentication Error', `Could not sign in. Google returned an error: "${resp.error}". This is often caused by a missing or incorrect "Authorized JavaScript Origin" for your deployment URL in the Google Cloud project.`);
                return;
            }
            await handleAuthSuccess();
        }

        signoutButton.onclick = () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateUIForSignedOut();
            }
        };

        async function handleAuthSuccess() {
            authStatus.textContent = 'Successfully connected to Google Drive.';
            authorizeButton.style.display = 'none';
            signoutButton.style.display = 'block';
            filePickerContainer.style.display = 'block';
        }

        function updateUIForSignedOut() {
            authStatus.textContent = 'You are not signed in.';
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
            filePickerContainer.style.display = 'none';
            step2Analysis.style.display = 'none';
            step3Run.style.display = 'none';
            fileListDiv.innerHTML = '';
            selectedFiles = [];
        }

        // --- File Picker ---
        function showPicker() {
            const token = gapi.client.getToken();
            if (!token) {
                showMessageModal("Authentication Error", "Your session has expired. Please connect to Google Drive again.");
                return;
            }

            const view = new google.picker.View(google.picker.ViewId.DOCS);
            view.setMimeTypes("text/plain,application/vnd.google-apps.document");
            
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setOAuthToken(token.access_token)
                .setDeveloperKey(API_KEY)
                .addView(view)
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
        }

        pickFilesButton.onclick = showPicker;

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                selectedFiles = data.docs;
                fileListDiv.innerHTML = '<h3 class="font-semibold text-gray-700">Selected Files:</h3>';
                const list = document.createElement('ul');
                list.className = 'list-disc list-inside bg-gray-100 p-3 rounded-md';
                selectedFiles.forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.textContent = file.name;
                    list.appendChild(listItem);
                });
                fileListDiv.appendChild(list);
                
                if (selectedFiles.length > 0) {
                    step2Analysis.style.display = 'block';
                    step3Run.style.display = 'block';
                }
            }
        }

        // --- UI Logic for Analysis Options ---
        frameworkCheckbox.addEventListener('change', (e) => {
            frameworkInputContainer.style.display = e.target.checked ? 'block' : 'none';
        });

        reflectionCheckbox.addEventListener('change', (e) => {
            reflectionModelContainer.style.display = e.target.checked ? 'block' : 'none';
        });
        
        frameworkFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    frameworkContent = event.target.result;
                };
                reader.readAsText(file);
            }
        });

        // --- Gemini API Integration ---
        async function performAnalysis(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "Analysis could not be generated due to an unexpected response from the AI.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showMessageModal("AI Analysis Failed", `An error occurred while contacting the Gemini API: ${error.message}`);
                throw error;
            }
        }


        // --- Main Analysis & Reporting ---
        runAnalysisButton.onclick = async () => {
            const selectedAnalyses = Array.from(document.querySelectorAll('input[name="analysis_type"]:checked')).map(cb => cb.value);
            if (selectedFiles.length === 0) {
                showMessageModal('Error', 'Please select at least one file from Google Drive.');
                return;
            }
            if (selectedAnalyses.length === 0) {
                showMessageModal('Error', 'Please choose at least one analysis type.');
                return;
            }
            if (selectedAnalyses.includes('framework') && !frameworkContent) {
                showMessageModal('Error', 'Please upload a framework file for framework-based analysis.');
                return;
            }

            resultsContainer.style.display = 'block';
            loader.style.display = 'flex';
            reportLinks.innerHTML = '';

            for (const file of selectedFiles) {
                try {
                    const fileContent = await getFileContent(file.id);
                    const analysisResults = {};

                    for (const type of selectedAnalyses) {
                        const prompt = generatePrompt(type, fileContent);
                        const result = await performAnalysis(prompt);
                        analysisResults[type] = result;
                    }
                    
                    generateWordDocument(file.name, fileContent, analysisResults, selectedAnalyses);

                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    const errorLink = document.createElement('p');
                    errorLink.className = 'text-red-500';
                    errorLink.textContent = `Failed to process ${file.name}. See console for details.`;
                    reportLinks.appendChild(errorLink);
                }
            }
            
            loader.style.display = 'none';
        };

        async function getFileContent(fileId) {
            try {
                const res = await gapi.client.drive.files.export({
                    fileId: fileId,
                    mimeType: 'text/plain'
                });
                return res.body;
            } catch (e) {
                console.log("Could not export, trying to get file content directly.");
                const res = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return res.body;
            }
        }

        function generatePrompt(analysisType, text) {
            let prompt = `You are a qualitative research assistant. Analyze the following text: "${text.substring(0, 8000)}".\n\n`;
            switch (analysisType) {
                case 'thematic':
                    prompt += "Perform a rigorous thematic analysis. Identify 3-5 key themes. For each theme, provide a clear title, a detailed description of the theme, and include at least two direct supporting quotes from the text to illustrate it. Format the output clearly with headings for each theme.";
                    break;
                case 'narrative':
                    prompt += "Perform a detailed narrative analysis. Identify the plot (setup, conflict, resolution), main characters and their roles, the primary setting, and any key narrative arcs or turning points. Discuss the overall structure and impact of the narrative. Format the output into clear sections for Plot, Characters, and Setting.";
                    break;
                case 'discourse':
                    prompt += "Perform a critical discourse analysis. Examine the specific use of language, the underlying social and power dynamics, and how language is used to construct meaning, identity, or authority within the text. Provide specific examples from the text to support your analysis. Focus on word choice, framing, and any implicit assumptions.";
                    break;
                case 'framework':
                    prompt += `Analyze the text using the following user-provided framework:\n\n---FRAMEWORK---\n${frameworkContent}\n\n---END FRAMEWORK---\n\nApply the text to each component of the framework. Provide a detailed evaluation for each component, explaining how the text aligns or doesn't align with it, using specific examples from the text.`;
                    break;
                case 'reflection':
                    const model = document.getElementById('reflection_model').value;
                    let modelDescription = '';
                    if (model === 'schon') modelDescription = "Sch√∂n's model of Reflection-in-Action and Reflection-on-Action. Analyze the text to identify specific moments of reflection. Distinguish between reflection that occurs during an event (in-action) and after an event (on-action), providing textual evidence for each.";
                    if (model === 'gibbs') modelDescription = "Gibbs' Reflective Cycle (Description, Feelings, Evaluation, Analysis, Conclusion, Action Plan). Structure the analysis according to these six stages, using the provided text to fill in each section of the cycle.";
                    if (model === 'moon') modelDescription = "Moon's Levels of Reflection (Noticing, Making Sense, Making Meaning, Working with Meaning, Transformative Learning). Assess the depth of reflection in the text according to these levels, providing justification and textual evidence for the level you assign.";
                    prompt += `Analyze the text using ${modelDescription}`;
                    break;
            }
            return prompt;
        }
        
        function generateWordDocument(fileName, originalText, results, analysisTypes) {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
            
            const sections = [
                {
                    children: [
                        new Paragraph({
                            text: `Analysis Report for: ${fileName}`,
                            heading: HeadingLevel.TITLE,
                        }),
                        new Paragraph({
                            text: `Date of Analysis: ${new Date().toLocaleDateString()}`,
                            style: "IntenseQuote"
                        }),
                    ],
                },
                {
                    children: [
                        new Paragraph({
                            text: "Original Text (Excerpt)",
                            heading: HeadingLevel.HEADING_1,
                        }),
                        new Paragraph({
                            text: originalText.substring(0, 2000) + (originalText.length > 2000 ? "..." : ""),
                            style: "BodyText"
                        }),
                     ]
                }
            ];

            analysisTypes.forEach(type => {
                let title = '';
                switch(type) {
                    case 'thematic': title = 'Thematic Analysis'; break;
                    case 'narrative': title = 'Narrative Analysis'; break;
                    case 'discourse': title = 'Discourse Analysis'; break;
                    case 'framework': title = 'Framework-Based Analysis'; break;
                    case 'reflection': 
                        const model = document.getElementById('reflection_model').options[document.getElementById('reflection_model').selectedIndex].text;
                        title = `Reflection Analysis: ${model}`;
                        break;
                }
                
                const resultParagraphs = results[type].split('\n').map(line => new Paragraph({ text: line }));

                sections.push({
                    properties: {},
                    children: [
                        new Paragraph({ text: title, heading: HeadingLevel.HEADING_1 }),
                        ...resultParagraphs
                    ]
                });
            });

            const doc = new Document({ sections });

            Packer.toBlob(doc).then(blob => {
                saveAs(blob, `Report-${fileName}.docx`);
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.textContent = `Download Report for ${fileName}`;
                link.download = `Report-${fileName}.docx`;
                link.className = 'block text-green-700 hover:underline';
                reportLinks.appendChild(link);
            });
        }
        
        // --- Modal ---
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }
        
        modalCloseButton.onclick = () => {
            messageModal.style.display = 'none';
        };

    </script>
</body>
</html>
